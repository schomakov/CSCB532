<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<div th:insert="~{header :: head}"></div>
<body class="d-flex flex-column min-vh-100">
<div th:replace="~{header :: header}"></div>
<main class="container mt-4">
    <h2 class="page-title"><i class="bi bi-truck"></i> Мои доставки</h2>
    <p class="text-muted" th:if="${currentEmployee == null}">Влезте като служител-куриер, за да виждате назначените ви пратки.</p>
    <div th:if="${parcels != null and parcels.isEmpty() and currentEmployee != null}" class="alert alert-info">
        Нямате текущи пратки за доставка.
    </div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="row" th:if="${parcels != null and !parcels.isEmpty()}">
        <div class="col-12">
            <div class="card">
                <div class="card-header"><i class="bi bi-list-check"></i> Пратки за доставка</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                            <tr>
                                <th>Код</th>
                                <th>Тип</th>
                                <th>Дестинация</th>
                                <th>Получател</th>
                                <th>Телефон</th>
                                <th>Плащане</th>
                                <th>Цена</th>
                                <th>Действия</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="p : ${parcels}">
                                <td th:text="${p.trackingCode}">TRK-XXX</td>
                                <td>
                                    <span th:if="${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_OFFICE}" class="badge bg-primary"><i class="bi bi-building"></i> До офис</span>
                                    <span th:if="${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_ADDRESS}" class="badge bg-secondary"><i class="bi bi-geo-alt"></i> До адрес</span>
                                </td>
                                <td>
                                    <span th:if="${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_OFFICE}" th:text="${p.toOffice != null ? p.toOffice.name : '-'}">Офис</span>
                                    <span th:if="${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_ADDRESS}">
                                        <span th:if="${p.deliveryAddress != null}" th:text="${(p.deliveryAddress.city != null ? p.deliveryAddress.city + ', ' : '') + (p.deliveryAddress.street != null ? p.deliveryAddress.street : '') + (p.deliveryAddress.details != null ? ', ' + p.deliveryAddress.details : '')}">адрес</span>
                                        <span th:if="${p.deliveryAddress == null}">-</span>
                                    </span>
                                </td>
                                <td th:text="${p.recipientName}">Име</td>
                                <td th:text="${p.recipientPhone}">тел.</td>
                                <td>
                                    <span th:if="${p.paymentType == T(com.nbu.CSCB532.model.logistics.PaymentType).SENDER_PAYS}" class="text-success">Платено от подател</span>
                                    <span th:if="${p.paymentType == T(com.nbu.CSCB532.model.logistics.PaymentType).RECIPIENT_PAYS}">
                                        <span th:if="${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_OFFICE}" class="text-warning">При взимане от офис</span>
                                        <span th:if="${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_ADDRESS}" class="text-warning">При доставка</span>
                                    </span>
                                </td>
                                <td th:text="${p.price != null ? p.price + ' лв.' : '-'}">-</td>
                                <td>
                                    <span th:if="${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_OFFICE} and ${p.status != T(com.nbu.CSCB532.model.logistics.ParcelStatus).AT_OFFICE}">
                                        <form th:action="@{/courier/parcels/{id}/arrived-at-office(id=${p.id})}" method="post" style="display:inline" onsubmit="return confirm('Маркирай като приета в офис?');">
                                            <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-building-check"></i> Приета в офис</button>
                                        </form>
                                    </span>
                                    <span th:if="${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_ADDRESS} or (${p.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_OFFICE} and ${p.status == T(com.nbu.CSCB532.model.logistics.ParcelStatus).AT_OFFICE})">
                                        <form class="courier-delivered-form" th:action="@{/courier/parcels/{id}/delivered(id=${p.id})}" method="post" style="display:inline">
                                            <input type="hidden" class="form-recipient-pays" th:value="${p.paymentType == T(com.nbu.CSCB532.model.logistics.PaymentType).RECIPIENT_PAYS}" />
                                            <input type="hidden" class="form-amount" th:value="${p.price != null ? p.price : 0}" />
                                            <button type="submit" class="btn btn-sm btn-success"><i class="bi bi-check-circle"></i> Доставена</button>
                                        </form>
                                    </span>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3" th:if="${parcels != null and !parcels.isEmpty()}">
        <p class="small text-muted">
            <strong>До офис:</strong> плащане при взимане от офис от клиент (ако е „Получател при предаване/доставка“).
            <strong>До адрес:</strong> плащане при доставка на място (ако е „Получател при предаване/доставка“).
        </p>
    </div>

    <!-- Модал за потвърждение на плащане при получаване -->
    <div class="modal fade" id="paymentConfirmModal" tabindex="-1" aria-labelledby="paymentConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentConfirmModalLabel">Потвърждение на плащане</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Сума за плащане: <strong id="paymentConfirmAmount">0.00</strong> лв.</p>
                    <p class="small text-muted mt-2 mb-0">При потвърждение пратката ще бъде маркирана като доставена и платена.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отказ</button>
                    <button type="button" class="btn btn-primary" id="paymentConfirmBtn"><i class="bi bi-check-lg me-1"></i> Потвърди</button>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:replace="~{footer :: footer}"></div>
<script th:inline="javascript">
(function() {
    const modal = document.getElementById('paymentConfirmModal');
    const amountEl = document.getElementById('paymentConfirmAmount');
    const confirmBtn = document.getElementById('paymentConfirmBtn');
    let formToSubmit = null;
    if (modal && amountEl && confirmBtn) {
        document.querySelectorAll('form.courier-delivered-form').forEach(function(f) {
            f.addEventListener('submit', function(e) {
                var rp = f.querySelector('input.form-recipient-pays');
                if (rp && rp.value === 'true') {
                    e.preventDefault();
                    var amt = f.querySelector('input.form-amount');
                    amountEl.textContent = amt ? amt.value : '0';
                    formToSubmit = f;
                    new bootstrap.Modal(modal).show();
                }
            });
        });
        confirmBtn.addEventListener('click', function() {
            if (formToSubmit) {
                formToSubmit.submit();
                formToSubmit = null;
            }
            var inst = bootstrap.Modal.getInstance(modal);
            if (inst) inst.hide();
        });
    }
})();
</script>
</body>
</html>
