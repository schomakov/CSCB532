<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<div th:insert="~{header :: head}"></div>
<body class="d-flex flex-column min-vh-100">
<div th:replace="~{header :: header}"></div>
<main class="container mt-4">
    <h2 class="page-title"><i class="bi bi-box-seam"></i> Пратки</h2>
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header"><i class="bi bi-pencil-square"></i> Създай/Редактирай пратка</div>
                <div class="card-body">
                    <form th:action="@{/admin/parcels}" method="post" th:object="${parcel}">
                        <input type="hidden" th:field="*{id}" />
                        <div class="mb-2">
                            <label class="form-label">Подател (клиент)</label>
                            <select class="form-select" th:field="*{sender.id}" required>
                                <option th:each="c : ${clients}" th:value="${c.id}"
                                        th:text="${c.user != null ? (c.user.username + ' - ' + c.user.firstName + ' ' + c.user.lastName) : c.id}"></option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Получател - име</label>
                                <input class="form-control" th:field="*{recipientName}" required />
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Получател - телефон</label>
                                <input class="form-control" th:field="*{recipientPhone}" required />
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Получател (клиент, по избор)</label>
                            <select class="form-select" th:field="*{recipientClient.id}">
                                <option value="">--</option>
                                <option th:each="c : ${clients}" th:value="${c.id}"
                                        th:text="${c.user != null ? (c.user.username + ' - ' + c.user.firstName + ' ' + c.user.lastName) : c.id}"></option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Тип доставка</label>
                            <select class="form-select" th:field="*{deliveryType}" required>
                                <option th:each="t : ${deliveryTypes}" th:value="${t}" th:text="${t}"></option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">От офис</label>
                                <select class="form-select" th:field="*{fromOffice.id}">
                                    <option value="">--</option>
                                    <option th:each="o : ${offices}" th:value="${o.id}" th:text="${o.name}"></option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2" th:if="${parcel.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_OFFICE}">
                                <label class="form-label">До офис</label>
                                <select class="form-select" th:field="*{toOffice.id}">
                                    <option value="">--</option>
                                    <option th:each="o : ${offices}" th:value="${o.id}" th:text="${o.name}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Тегло (кг)</label>
                                <input type="number" step="0.01" min="0" class="form-control" th:field="*{weightKg}" required />
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Цена</label>
                                <input type="number" step="0.01" min="0" class="form-control" th:field="*{price}" placeholder="авто" />
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Плащане</label>
                                <select class="form-select" th:field="*{paymentType}">
                                    <option value="">--</option>
                                    <option th:each="pt : ${paymentTypes}" th:value="${pt}" th:text="${pt == T(com.nbu.CSCB532.model.logistics.PaymentType).SENDER_PAYS ? 'Подател при изпращане' : 'Получател при доставка'}">-</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Статус</label>
                                <select class="form-select" th:field="*{status}" required>
                                    <option th:each="s : ${parcelStatuses}" th:value="${s}" th:text="${s}"></option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Куриер</label>
                                <select class="form-select" th:field="*{courier.id}">
                                    <option value="">--</option>
                                    <option th:each="e : ${employees}" th:value="${e.id}"
                                            th:text="${e.user != null ? (e.user.firstName + ' ' + e.user.lastName) : e.id}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="border rounded p-3 mb-3">
                            <h6>Адрес за доставка (ако е до адрес)</h6>
                            <div class="row">
                                <div class="col-md-3 mb-2"><input class="form-control" placeholder="Държава" th:field="*{deliveryAddress.country}" /></div>
                                <div class="col-md-3 mb-2"><input class="form-control" placeholder="Град" th:field="*{deliveryAddress.city}" /></div>
                                <div class="col-md-3 mb-2"><input class="form-control" placeholder="Пощ. код" th:field="*{deliveryAddress.zipCode}" /></div>
                                <div class="col-md-3 mb-2"><input class="form-control" placeholder="Улица" th:field="*{deliveryAddress.street}" /></div>
                            </div>
                            <input class="form-control" placeholder="Детайли" th:field="*{deliveryAddress.details}" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Описание</label>
                            <input class="form-control" th:field="*{description}" placeholder="съдържание на пратката" maxlength="500" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Тракинг код</label>
                            <input class="form-control" th:field="*{trackingCode}" placeholder="авто" />
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Запази</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card mb-2">
                <div class="card-header"><i class="bi bi-funnel"></i> Филтър</div>
                <div class="card-body py-2">
                    <form method="get" action="#" th:action="@{/admin/parcels}" id="filterForm">
                        <div class="mb-2">
                            <label class="form-label small">Покажи</label>
                            <select class="form-select form-select-sm" name="filter" id="parcelFilter">
                                <option value="all" th:selected="${filter == 'all'}">Всички регистрирани пратки</option>
                                <option value="byEmployee" th:selected="${filter == 'byEmployee'}">Регистрирани от служител</option>
                                <option value="notReceived" th:selected="${filter == 'notReceived'}">Изпратени, но неполучени</option>
                                <option value="bySender" th:selected="${filter == 'bySender'}">Изпратени от клиент</option>
                                <option value="byRecipient" th:selected="${filter == 'byRecipient'}">Получени от клиент</option>
                            </select>
                        </div>
                        <div class="mb-2" id="filterEmployeeBlock" style="display:none;">
                            <label class="form-label small">Служител</label>
                            <select class="form-select form-select-sm" name="employeeId" id="filterEmployeeId">
                                <option value="">-- изберете --</option>
                                <option th:each="e : ${employees}" th:value="${e.id}" th:text="${e.user != null ? (e.user.firstName + ' ' + e.user.lastName) : ('ID ' + e.id)}" th:selected="${filterEmployeeId != null and filterEmployeeId == e.id}"></option>
                            </select>
                        </div>
                        <div class="mb-2" id="filterClientBlock" style="display:none;">
                            <label class="form-label small">Клиент</label>
                            <select class="form-select form-select-sm" name="clientId" id="filterClientId">
                                <option value="">-- изберете --</option>
                                <option th:each="c : ${clients}" th:value="${c.id}" th:text="${c.user != null ? (c.user.username + ' - ' + c.user.firstName + ' ' + c.user.lastName) : c.id}" th:selected="${filterClientId != null and filterClientId == c.id}"></option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-search me-1"></i> Покажи</button>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><i class="bi bi-list-ul"></i> Списък</div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Код</th>
                                <th>Статус</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="p : ${parcels}">
                                <td th:text="${p.id}">1</td>
                                <td th:text="${p.trackingCode}">TRK-XXXX</td>
                                <td th:text="${p.status}">REGISTERED</td>
                                <td class="text-end">
                                    <a th:href="@{/admin/parcels/{id}/edit(id=${p.id})}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil me-1"></i>Редактирай</a>
                                    <form th:action="@{/admin/parcels/{id}/delete(id=${p.id})}" method="post" style="display:inline" onsubmit="return confirm('Изтриване?');">
                                        <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash me-1"></i>Изтрий</button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:replace="~{footer :: footer}"></div>
<script th:inline="javascript">
(function() {
    var parcelFilter = document.getElementById('parcelFilter');
    var filterEmployeeBlock = document.getElementById('filterEmployeeBlock');
    var filterClientBlock = document.getElementById('filterClientBlock');
    var filterEmployeeId = document.getElementById('filterEmployeeId');
    var filterClientId = document.getElementById('filterClientId');
    function updateFilterBlocks() {
        var v = parcelFilter ? parcelFilter.value : 'all';
        if (filterEmployeeBlock) filterEmployeeBlock.style.display = (v === 'byEmployee') ? 'block' : 'none';
        if (filterClientBlock) filterClientBlock.style.display = (v === 'bySender' || v === 'byRecipient') ? 'block' : 'none';
        if (filterEmployeeId && v !== 'byEmployee') filterEmployeeId.removeAttribute('required'); else if (filterEmployeeId && v === 'byEmployee') filterEmployeeId.setAttribute('required', 'required');
        if (filterClientId && v !== 'bySender' && v !== 'byRecipient') filterClientId.removeAttribute('required'); else if (filterClientId && (v === 'bySender' || v === 'byRecipient')) filterClientId.setAttribute('required', 'required');
    }
    if (parcelFilter) {
        parcelFilter.addEventListener('change', updateFilterBlocks);
        updateFilterBlocks();
    }
})();
</script>
</body>
</html>
