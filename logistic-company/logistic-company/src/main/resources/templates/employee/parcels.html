<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<div th:insert="~{header :: head}"></div>
<body class="d-flex flex-column min-vh-100">
<div th:replace="~{header :: header}"></div>
<main class="container mt-4">
    <h2 class="page-title"><i class="bi bi-box-seam"></i> Служител: Пратки</h2>
    <div class="row">
        <div class="col-md-7">
            <div th:if="${error}" class="alert alert-danger mb-3" th:text="${error}"></div>
        <div class="card mb-3">
                <div class="card-header"><i class="bi bi-plus-square"></i> Регистрирай изпратена пратка</div>
                <div class="card-body">
                    <form th:action="@{/employee/parcels}" method="post" th:object="${parcel}">
                        <div class="mb-2">
                            <label class="form-label">Подател (клиент)</label>
                            <select class="form-select" th:field="*{sender.id}" required>
                                <option th:each="c : ${clients}" th:value="${c.id}"
                                        th:text="${c.user != null ? (c.user.username + ' - ' + c.user.firstName + ' ' + c.user.lastName) : c.id}"></option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Получател (клиент)</label>
                            <select class="form-select" name="recipientClientId" id="recipientClientSelect">
                                <option value="">-- Ръчно въвеждане име и телефон --</option>
                                <option th:each="c : ${clients}" th:value="${c.id}"
                                        th:attr="data-name=${c.user != null ? (c.user.firstName + ' ' + c.user.lastName) : ''}, data-phone=${c.phone != null ? c.phone : ''}"
                                        th:text="${c.user != null ? (c.user.username + ' - ' + c.user.firstName + ' ' + c.user.lastName) : c.id}"></option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Получател - име</label>
                                <input class="form-control" name="recipientName" id="recipientNameInput" placeholder="задължително при ръчно въвеждане" />
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Получател - телефон</label>
                                <input class="form-control" name="recipientPhone" id="recipientPhoneInput" placeholder="при ръчно въвеждане" />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Тип доставка</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="deliveryTypeToggle" id="deliveryToOffice" value="TO_OFFICE" th:checked="${parcel.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_OFFICE}" autocomplete="off" />
                                <label class="btn btn-outline-primary" for="deliveryToOffice"><i class="bi bi-building me-1"></i> До офис</label>
                                <input type="radio" class="btn-check" name="deliveryTypeToggle" id="deliveryToAddress" value="TO_ADDRESS" th:checked="${parcel.deliveryType == T(com.nbu.CSCB532.model.logistics.DeliveryType).TO_ADDRESS}" autocomplete="off" />
                                <label class="btn btn-outline-primary" for="deliveryToAddress"><i class="bi bi-geo-alt me-1"></i> До адрес</label>
                            </div>
                            <input type="hidden" th:field="*{deliveryType}" id="deliveryTypeValue" />
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">От офис</label>
                                <select class="form-select" th:field="*{fromOffice.id}">
                                    <option value="">--</option>
                                    <option th:each="o : ${offices}" th:value="${o.id}"
                                            th:selected="${currentEmployee != null and currentEmployee.office != null and currentEmployee.office.id == o.id}"
                                            th:text="${o.name}"></option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2" id="toOfficeBlock">
                                <label class="form-label">До офис</label>
                                <select class="form-select" id="toOfficeSelect" th:field="*{toOffice.id}">
                                    <option value="">-- Изберете офис --</option>
                                    <option th:each="o : ${offices}" th:value="${o.id}" th:text="${o.name}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="border rounded p-3 mb-3 bg-light" id="addressBlock">
                            <h6 class="text-muted"><i class="bi bi-geo-alt"></i> Адрес за доставка</h6>
                            <div class="row">
                                <div class="col-md-3 mb-2"><input class="form-control" placeholder="Държава" name="addrCountry" id="addrCountry" /></div>
                                <div class="col-md-3 mb-2"><input class="form-control" placeholder="Град" name="addrCity" id="addrCity" /></div>
                                <div class="col-md-3 mb-2"><input class="form-control" placeholder="Пощ. код" name="addrZip" id="addrZip" /></div>
                                <div class="col-md-3 mb-2"><input class="form-control" placeholder="Улица" name="addrStreet" id="addrStreet" /></div>
                            </div>
                            <input class="form-control" placeholder="Детайли" name="addrDetails" id="addrDetails" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Описание на пратката</label>
                            <input class="form-control" th:field="*{description}" placeholder="напр. документи, книги, електроника" maxlength="500" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Тегло (кг)</label>
                                <input type="number" step="0.01" min="0" class="form-control" id="weightKg" th:field="*{weightKg}" required />
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Плащане</label>
                                <select class="form-select" th:field="*{paymentType}">
                                    <option th:each="pt : ${paymentTypes}" th:value="${pt}" th:text="${pt == T(com.nbu.CSCB532.model.logistics.PaymentType).SENDER_PAYS ? 'Подател при изпращане' : 'Получател при предаване/доставка'}">-</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Цена (лв.)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="priceInput" th:field="*{price}" readonly placeholder="5 + 4×тегло" title="До офис: 5 + 4×тегло; до адрес: 7.50 + 4×тегло (кг)" />
                            <div class="form-text" id="priceFormulaText">Изчислява се: 5 + 4×тегло (до офис)</div>
                        </div>

                        <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Регистрирай</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <div class="card mb-2">
                <div class="card-header"><i class="bi bi-funnel"></i> Филтър</div>
                <div class="card-body py-2">
                    <form method="get" action="#" th:action="@{/employee/parcels}" id="filterForm">
                        <div class="mb-2">
                            <label class="form-label small">Покажи</label>
                            <select class="form-select form-select-sm" name="filter" id="parcelFilter">
                                <option value="all" th:selected="${filter == 'all'}">Всички регистрирани пратки</option>
                                <option value="byEmployee" th:selected="${filter == 'byEmployee'}">Регистрирани от служител</option>
                                <option value="notReceived" th:selected="${filter == 'notReceived'}">Изпратени, но неполучени</option>
                                <option value="bySender" th:selected="${filter == 'bySender'}">Изпратени от клиент</option>
                                <option value="byRecipient" th:selected="${filter == 'byRecipient'}">Получени от клиент</option>
                            </select>
                        </div>
                        <div class="mb-2" id="filterEmployeeBlock" style="display:none;">
                            <label class="form-label small">Служител</label>
                            <select class="form-select form-select-sm" name="employeeId" id="filterEmployeeId">
                                <option value="">-- изберете --</option>
                                <option th:each="e : ${employees}" th:value="${e.id}" th:text="${e.user != null ? (e.user.firstName + ' ' + e.user.lastName) : ('ID ' + e.id)}" th:selected="${filterEmployeeId != null and filterEmployeeId == e.id}"></option>
                            </select>
                        </div>
                        <div class="mb-2" id="filterClientBlock" style="display:none;">
                            <label class="form-label small">Клиент</label>
                            <select class="form-select form-select-sm" name="clientId" id="filterClientId">
                                <option value="">-- изберете --</option>
                                <option th:each="c : ${clients}" th:value="${c.id}" th:text="${c.user != null ? (c.user.username + ' - ' + c.user.firstName + ' ' + c.user.lastName) : c.id}" th:selected="${filterClientId != null and filterClientId == c.id}"></option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-search me-1"></i> Покажи</button>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><i class="bi bi-list-ul"></i> Пратки</div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Код</th>
                                <th>Тегло</th>
                                <th>Плащане</th>
                                <th>Статус</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="p : ${parcels}">
                                <td th:text="${p.id}">1</td>
                                <td th:text="${p.trackingCode}">TRK-XXXX</td>
                                <td th:text="${p.weightKg != null ? p.weightKg + ' кг' : '-'}">-</td>
                                <td th:text="${p.paymentType != null ? (p.paymentType == T(com.nbu.CSCB532.model.logistics.PaymentType).SENDER_PAYS ? 'Подател' : 'При доставка') : '-'}">-</td>
                                <td th:text="${p.status}">REGISTERED</td>
                                <td class="text-end">
                                    <form th:action="@{/employee/parcels/{id}/arrived-at-office(id=${p.id})}" method="post" style="display:inline"
                                      th:if="${p.status != T(com.nbu.CSCB532.model.logistics.ParcelStatus).AT_OFFICE and p.status != T(com.nbu.CSCB532.model.logistics.ParcelStatus).DELIVERED}">
                                        <button class="btn btn-sm btn-outline-secondary">Приета в офис</button>
                                    </form>
                                    <form class="employee-receive-form" th:action="@{/employee/parcels/{id}/receive(id=${p.id})}" method="post" style="display:inline"
                                          th:if="${p.status != T(com.nbu.CSCB532.model.logistics.ParcelStatus).DELIVERED}">
                                        <input type="hidden" class="form-recipient-pays" th:value="${p.paymentType == T(com.nbu.CSCB532.model.logistics.PaymentType).RECIPIENT_PAYS}" />
                                        <input type="hidden" class="form-amount" th:value="${p.price != null ? p.price : 0}" />
                                        <button type="submit" class="btn btn-sm btn-outline-success"><i class="bi bi-check-circle me-1"></i>Получена</button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модал за потвърждение на плащане при получаване -->
    <div class="modal fade" id="paymentConfirmModal" tabindex="-1" aria-labelledby="paymentConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentConfirmModalLabel">Потвърждение на плащане</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Сума за плащане: <strong id="paymentConfirmAmount">0.00</strong> лв.</p>
                    <p class="small text-muted mt-2 mb-0">При потвърждение пратката ще бъде маркирана като получена и платена.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отказ</button>
                    <button type="button" class="btn btn-primary" id="paymentConfirmBtn"><i class="bi bi-check-lg me-1"></i> Потвърди</button>
                </div>
            </div>
        </div>
    </div>
</main>
<div th:replace="~{footer :: footer}"></div>
<script th:inline="javascript">
(function() {
    const deliveryToOffice = document.getElementById('deliveryToOffice');
    const deliveryToAddress = document.getElementById('deliveryToAddress');
    const deliveryTypeValue = document.getElementById('deliveryTypeValue');
    const toOfficeBlock = document.getElementById('toOfficeBlock');
    const toOfficeSelect = document.getElementById('toOfficeSelect');
    const addressBlock = document.getElementById('addressBlock');
    const addressInputs = addressBlock ? addressBlock.querySelectorAll('input') : [];
    const recipientClientSelect = document.getElementById('recipientClientSelect');
    const recipientNameInput = document.querySelector('input[name*="recipientName"]');
    const recipientPhoneInput = document.querySelector('input[name*="recipientPhone"]');
    const weightKg = document.getElementById('weightKg');
    const priceInput = document.getElementById('priceInput');

    var parcelFilter = document.getElementById('parcelFilter');
    var filterEmployeeBlock = document.getElementById('filterEmployeeBlock');
    var filterClientBlock = document.getElementById('filterClientBlock');
    var filterEmployeeId = document.getElementById('filterEmployeeId');
    var filterClientId = document.getElementById('filterClientId');
    function updateFilterBlocks() {
        var v = parcelFilter ? parcelFilter.value : 'all';
        if (filterEmployeeBlock) filterEmployeeBlock.style.display = (v === 'byEmployee') ? 'block' : 'none';
        if (filterClientBlock) filterClientBlock.style.display = (v === 'bySender' || v === 'byRecipient') ? 'block' : 'none';
        if (filterEmployeeId && v !== 'byEmployee') filterEmployeeId.removeAttribute('required'); else if (filterEmployeeId && v === 'byEmployee') filterEmployeeId.setAttribute('required', 'required');
        if (filterClientId && v !== 'bySender' && v !== 'byRecipient') filterClientId.removeAttribute('required'); else if (filterClientId && (v === 'bySender' || v === 'byRecipient')) filterClientId.setAttribute('required', 'required');
    }
    if (parcelFilter) {
        parcelFilter.addEventListener('change', updateFilterBlocks);
        updateFilterBlocks();
    }

    var priceBase = 5;
    function setDeliveryType(value) {
        if (deliveryTypeValue) deliveryTypeValue.value = value;
        priceBase = value === 'TO_ADDRESS' ? 7.5 : 5;
        const isToOffice = value === 'TO_OFFICE';
        if (toOfficeBlock && toOfficeSelect) {
            toOfficeBlock.classList.toggle('pe-none', !isToOffice);
            toOfficeSelect.disabled = !isToOffice;
            toOfficeSelect.required = isToOffice;
            if (!isToOffice) toOfficeSelect.value = '';
        }
        if (addressBlock) {
            addressBlock.classList.toggle('pe-none', isToOffice);
            addressBlock.querySelectorAll('input').forEach(function(inp) { inp.disabled = isToOffice; });
        }
        updatePriceFormula();
        if (typeof updatePrice === 'function') updatePrice();
    }
    function updatePriceFormula() {
        const formulaText = document.getElementById('priceFormulaText');
        if (formulaText) formulaText.textContent = 'Изчислява се: ' + priceBase + ' + 4×тегло (' + (priceBase === 5 ? 'до офис' : 'до адрес') + ')';
        if (priceInput) {
            priceInput.placeholder = priceBase + ' + 4×тегло';
            priceInput.title = 'Изчислява се автоматично: ' + priceBase + ' + 4×тегло (кг)';
        }
    }

    if (deliveryToOffice && deliveryToAddress && deliveryTypeValue) {
        deliveryToOffice.addEventListener('change', function() { setDeliveryType('TO_OFFICE'); });
        deliveryToAddress.addEventListener('change', function() { setDeliveryType('TO_ADDRESS'); });
        var initial = (deliveryTypeValue.value || 'TO_OFFICE').toUpperCase();
        if (initial === 'TO_OFFICE') deliveryToOffice.checked = true; else deliveryToAddress.checked = true;
        setDeliveryType(initial);
    } else {
        updatePriceFormula();
    }

    if (recipientClientSelect && recipientNameInput && recipientPhoneInput) {
        recipientClientSelect.addEventListener('change', function() {
            const opt = this.options[this.selectedIndex];
            if (opt && opt.value) {
                recipientNameInput.value = opt.getAttribute('data-name') || '';
                recipientPhoneInput.value = opt.getAttribute('data-phone') || '';
            }
        });
    }

    function updatePrice() {
        if (!weightKg || !priceInput) return;
        const w = parseFloat(weightKg.value);
        if (!isNaN(w) && w >= 0) {
            const base = (typeof priceBase !== 'undefined') ? priceBase : 5;
            const price = (base + 4 * w).toFixed(2);
            priceInput.value = price;
        } else {
            priceInput.value = '';
        }
    }
    if (weightKg) {
        weightKg.addEventListener('input', updatePrice);
        weightKg.addEventListener('change', updatePrice);
        updatePrice();
    }

    var paymentModal = document.getElementById('paymentConfirmModal');
    var paymentAmountEl = document.getElementById('paymentConfirmAmount');
    var paymentConfirmBtn = document.getElementById('paymentConfirmBtn');
    var formToSubmit = null;
    if (paymentModal && paymentAmountEl && paymentConfirmBtn) {
        document.querySelectorAll('form.employee-receive-form').forEach(function(f) {
            f.addEventListener('submit', function(e) {
                var rp = f.querySelector('input.form-recipient-pays');
                if (rp && rp.value === 'true') {
                    e.preventDefault();
                    var amt = f.querySelector('input.form-amount');
                    paymentAmountEl.textContent = amt ? amt.value : '0';
                    formToSubmit = f;
                    new bootstrap.Modal(paymentModal).show();
                }
            });
        });
        paymentConfirmBtn.addEventListener('click', function() {
            if (formToSubmit) {
                formToSubmit.submit();
                formToSubmit = null;
            }
            var inst = bootstrap.Modal.getInstance(paymentModal);
            if (inst) inst.hide();
        });
    }
})();
</script>
</body>
</html>
